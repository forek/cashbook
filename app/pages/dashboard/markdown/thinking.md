### 设计思路
在本文中，我会简单描述我在解决本题目时的思考过程，包括对题目的理解和思考、技术选型抉择策略、实现细节思考等等。

---

#### 准备阶段
当我拿到题目并仔细审题之后，我发现这个题目除了明面上的信息以外，背后还藏有许多需要开发者思考的问题，这些问题会影响系统的基础选型和整体开发方向，所以我必须在动手开发之前先解决这些问题：

##### 数据持久化怎么做？
第一个反应过来的问题就是数据持久化，主流实现方式无非就是两个方向：1. 前端储存，即使用浏览器的localStorage或着IndexDB储存账单数据；2. 服务端储存，把账单数据储存到服务端文件或者数据库中。

前端储存代码开发比较简单，但是数据无法跨浏览器共享，而且数据也比较容易因为误清理等情况丢失，既然是账单类应用那我认为基于可靠性考虑，应该使用服务端储存。

服务端储存我一开始考虑过简化操作，直接将数据存放在本地csv文件中而不使用数据库，但是考虑到文件读写是重IO操作，而且无法直接用csv文件执行查询，每次操作都必须遍历并解析一次整个文件，思考至此发现本地csv文件的方案在各个方面都不合适，所以即使只是一个很简单的小应用最后也决定使用SQL数据库（选择了部署简便的单文件数据库 sqlite）。

##### UI组件和功能需要原创开发吗？
原创开发和使用UI框架各有优劣：

* 原创开发可以更好地展示我的个人能力。但是放到实际工作中，当社区上已经有成熟的、符合需求的开源产品的情况下，再进行原创开发就变成重复造轮子，费时费力且没有太大意义。
* 使用UI框架可以节省大量开发基础组件所需的时间，而且成熟的框架有一整个社区进行支持，可靠性比较高。但是使用是有限制的，如果是由设计师设计一套原创UI样式的场景，就不应该使用UI框架。

考虑到xmind产品的性质，一开始我觉得这个题目包含了考察开发者基础组件开发能力的想法在里面的。但是由于题目已经明确了“不设置任何的技术限制”并且对UI样式没有要求，加上时间方面比较紧，所以我最后决定使用Ant Design框架作为UI框架。

##### 需要实现响应式布局吗？
我认为这个应用的目标平台是桌面端，但是Ant Design的桌面版对响应式的支持非常有限，实际上交互比较复杂的应用也很难实现响应式，所以应该优先确保桌面端的可用性，而移动端只需要在正常使用的前提下适当提升用户体验即可。

##### 技术如何选型?
这里我选择了自己比较熟悉的技术栈，也是现在比较常见的技术栈：

* 基础平台：Node.js
* 服务器框架：Koa2
* 数据库：sqlite
* 前端框架：React
* UI框架：Ant Design
* 打包工具：webpack

##### 除了题目要求的功能以外，还打算实现哪些功能？
作为一个有想法的开发者，我打算在题目要求的功能基础上，增加一些我认为很有用的功能，使得这个应用更加完善：

* 编辑/删除账单
* “账单分类”管理
* 数据实时更新、多人同时编辑

首先既然已经使用了SQL数据库，编辑/删除的实现就很方便了，而且这对于账单应用来说也是必要的功能。

然后“账单分类”管理功能也是需要的，可以让使用者清晰地看到目前分类类型有哪些，以及增加新的分类。但是删除分类是不允许的，因为删除分类会导致账单表中分类失去关联数据。

最后我认为“数据实时更新、多人同时编辑”是最有趣的，我决定使用socket技术，将最新的数据推送到所有连接的客户端以实现“数据实时更新”。而至于“多人同时编辑”功能，主要是要解决数据滞后问题和操作冲突。由于客户端的数据都是实时的，不同用户同时编辑账单的时候就不会出现数据滞后的问题，再在后端处理好不同用户对同一条数据进行操作产生的冲突并返回适当提示，就可以实现“多人同时编辑”。

---

#### 开发阶段
经过准备阶段的思考之后，这个项目的方向已经大致定了下来。接下来我将根据各个功能点，分别讲述开发过程中遇到的问题和我的解决方案。

##### 加载题目所提供的数据
这里我选择使用“用户自行导入表单”的方式实现，当启动空项目后，数据库内部没有任何数据，此时需要用户自行通过操作栏的导入按钮，上传账单表和类型表。我认为用户导入的方式比数据库内预设数据的方式更合理，而且有需要的话，用户可以继续导入更多其他表格，把数据添加到数据库中。

上传的表格时会对文件格式和表头进行验证，当用户上传不符合类型的文件时会返回相应提示。

##### 以列表的形式展示账单内容，并且提供下拉框选择月份进行筛选
账单的展示使用了Ant Design的Table组件，并且用这个组件自带的筛选功能实现了月份筛选和数据展示。

如果月份太多的话，Table组件的筛选列表会变得很长且不方便操作，所以我在操作栏添加了一个DatePicker组件供筛选使用，两个筛选的数据是保持一致的。

##### 支持使用者添加账单
“添加账单”和我新增的“编辑/删除”功能是一起设计的。

首先通过Table的“可编辑行”和后端服务器接口实现了“编辑/删除”功能，使用户可以在表格原地编辑账单数据。

然后“添加账单”的实现方式是，向表格数据里添加一个临时数据并置为编辑状态，用户点击保存时，判断为临时数据即调用创建接口而不是更新接口。

这里还有一些细节处理。由于编辑功能是在表格数据原地进行的，如果进入编辑状态后，用户更改筛选排序条件的话，编辑框可能因为不符合筛选条件而消失，所以我限制了编辑状态下用户不能更改筛选排序条件。另外，当用户激活了筛选条件后再新增数据，默认数据会设置为符合筛选条件。

##### 简单地统计并展示所选月份的收入和支出总金额
统计数据的工作也放在前端进行，当碰到金钱计算的时候，就遇到一个经典问题 ———— 浮点数精度问题。直接使用浮点数计算金额的话，可能会因为精度问题导致计算结果有误，所以我选用了decimal.js库来计算月收支总额。

另外，除了月收支总额统计，还提供了针对分类筛选结果的月收支金额统计。

##### 对账单分类进行二次筛选
同样地，账单分类筛选也通过Table组件的筛选功能实现。

##### 对选择月份内的所有账单根据账单分类进行支出金额统计，并进行排序
只需要在触发月份筛选的时候，计算出当月账单分类支出金额结果并保存，再在总表下方添加一个新表单独显示这个结果即可，而排序则是用Table组件的默认排序功能实现的。

##### 编辑/删除账单
除了上文“支持使用者添加账单”中描述的特性外，实现这个功能时我还注意到了一些细节：账单表的“账单分类”的“是否可选”值是“否”，这意味着账单表的数据分类项可以为空，但是账单类型（收入或支出）却是必填的。

基于这个细节，我为系统添加了一个默认分类“其他分类”来表示分类为空的情况。由于在分类表中，分类和收支类型是强相关的，每一个非空分类都对应了一个固定的收支类型，所以在编辑的时候，当用户选择分类为非空分类时，收支类型不可编辑并强制使用分类对应的收支类型。而“其他分类”没有固定的收支类型，所以用户选择“其他分类”时，可以手动选择该数据的收支类型。

##### “账单分类”管理
在新页面上提供了“账单分类”管理功能，使用者可以直观地看到当前系统里有哪些分类可用，并且可以单独添加新的分类。

##### 数据实时更新、多人同时编辑
就如上文所说，“数据实时更新”是通过socket技术实现的，但是实现的时候却面临一个艰难的抉择：筛选、排序、分页、统计等功能由前端实现还是后端实现？

前端实现可以通过Ant Design的Table组件自带功能来处理数据，不需要我自行编写筛选、排序、分页这些逻辑，但这意味着每次打开应用都必须全量推送账单数据，当数据量较大的时候数据传输和JS处理数据都会耗费很多时间。

后端实现在数据量较大的时候也能保证每次只传输当前需要显示的数据，前端接收和处理这些少量数据速度会更快。但是后端实现除了要自行编写筛选、排序、分页逻辑以外，还需要实时保存每个用户的筛选、排序、分页条件，以保证在数据更新的时候，能按照用户当前选择条件计算并推送相应的数据，这一系列的逻辑比前端实现复杂得多。再者，后端实现意味着所有计算压力都放到服务端，连接数较高的时候服务端压力会较大。

这个时候就得考虑一下这个应用最有可能的使用场景了。作为一个简单的账单应用，我最有可能把它用在家庭记账或者个人记账之类的小规模场景中，部署服务的设备可能是一块链接在路由器上的树莓派或者类似的低性能设备。这个类场景的特点是：服务器资源少、数据量少、连接数低，在这样的场景中选用前端实现可以达到快速开并且保证较高的可靠性和稳定性的目的。

基于以上的考虑，我在实现这个应用的时候，选择了由前端实现筛选、排序、分页、统计等功能。

而“多人同时编辑”功能，我设想了一系列可能会出现的冲突情况，并做了相应的处理：

* 用户正在编辑（未保存）的数据被其他用户删除：退出编辑状态并提示“正在编辑的数据已被删除”
* 用户正在编辑（未保存）的数据被其他用户更新：编辑控件重置为新数据并提示“正在编辑的数据已更新，请重新编辑”
* 更新一条不存在的数据：提示“更新失败，数据不存在”
* 删除一条不存在的数据：不提示错误
* 两个用户同时更新同一条数据：后者更新内容覆盖前者
* 新增账单数据不会失败

我实现了以上所有逻辑对每个情况都进行了测试，相信这个功能可以很好地支持多人同时编辑。

---

#### 其他问题或细节
##### 性能优化
除了代码本身有考虑到运行性能外，我还为数据统计计算结果设计了缓存，在整体数据未更新时，月份收支总额和分类金额统计不会重复计算。

##### 测试用例
由于时间较紧，这次项目开发并没有添加测试用例代码而改由人力测试代替，时间充裕的情况下我一般都会配套测试代码的。
